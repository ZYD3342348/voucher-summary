---
name: 总台财务汇总生成器
description: 生成总台财务数据汇总表，包含透视表、凭证说明、调整S计算和验证链路。自动读取收入类型表明细，动态生成Excel公式；可自动按名称首字母提取收入类型并校验，避免公式引用错位。
---

# 总台财务汇总生成器

## 快速开始

```bash
cd /Users/zengyuntan/python/凭证处理/2025年12月
python3 scripts/generate_summary.py -i "12月总台.XLS.xlsx" -t 600240
# 规范化总数表为长表（可选，用于提取转账等）
python3 scripts/normalize_total.py -i "2025年10月总台测试.xlsx" -s "总数" -o "2025年10月总数_long.csv"
```

## 使用方式

### 方式一：命令行参数（推荐）

```bash
python3 scripts/generate_summary.py \
    -i "12月总台.XLS.xlsx" \   # 输入文件（必填）
    -o "汇总输出.xlsx" \       # 输出文件
    -t 600240 \                # 转账金额（必填）
    -s "收入类型表"            # 工作表名
```

### 方式二：修改配置区

编辑 `scripts/generate_summary.py` 顶部：

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `INPUT_FILE` | 源数据Excel文件 | `12月总台.XLS.xlsx` |
| `OUTPUT_FILE` | 输出文件 | `12月汇总输出.xlsx` |
| `TRANSFER_AMOUNT` | 转账金额 | `600240` |
| `SHEET_NAME` | 工作表名 | `收入类型表` |

## 数据格式要求

### 输入文件结构

源Excel需包含 `收入类型表`（或指定的表名），无收入类型列时脚本会按名称首字母自动提取：

```
明细数据区域 (行1-6500+)
├── 项目  名称        [收入类型]  金额
├── 房费  Z福田区...    Z        360
└── ...

透视表区域 (行6506+)
├── 收入类型  房费    总计
├── H        1328805  2661575.43
├── L        92240    250590
└── 总计     2345865  3838997.43
```

### 收入类型识别

单位名称首字母标识类型（脚本会自动提取并填补缺失；存在原始收入类型列时会校验差异）：
- `Z` - 政府机关
- `L` - 老干部/财政
- `H` - 会议/内部成本
- `R` - 人才
- `S` - 散客
- `T` - 其他事业单位

## 输出结构

生成的Excel包含以下区域：

| 区域 | 行号 | 内容 |
|------|------|------|
| 配置区 | 1-2 | 转账金额、数据文件 |
| 透视表 | 6-13 | H/L/R/S/T/Z 房费及合计 |
| 凭证说明 | 16-21 | H/L/T/调整S凭证及合计 |
| 验证 | 23-26 | 房费剩余 vs 凭证合计校验 |

总数表规范化（可选）：
- 输入：含科目代码/名称/借方/贷方的“总数”表。
- 输出：长表列 `code,name,debit,credit,source_file,source_row`，便于程序化取数（如 `name == "转账"` 取贷方金额）。

## 公式引用链

```
透视表房费(B7,B8,B11)
    ↓
凭证金额(C17,C18,C19,C20)
    ↓
凭证合计(C21)
    ↓
验证(B26): IF(房费剩余=凭证合计)
```

## 调整S计算逻辑

```
调整S = 房费总计 - 转账金额 - H房费 - L房费 - T房费
```

验证：`房费剩余 = H + L + T + 调整S`

## 扩展用法

### 多月份数据处理

```python
# 修改配置区
INPUT_FILE = '2025年11月总台.XLS.xlsx'
OUTPUT_FILE = '11月汇总输出.xlsx'
TRANSFER_AMOUNT = 573500  # 从对应月份的总数表获取
```

### 更换工作表名

```python
SHEET_NAME = '收入类型'  # 非默认工作表名
```

## 故障排除

| 问题 | 原因 | 解决 |
|------|------|------|
| 透视表未找到 | 工作表名错误 | 检查 `SHEET_NAME` |
| 金额为0 | 数据类型错误 | 确保金额列为数值 |
| 验证失败 | 公式引用错误 | 使用动态坐标生成公式 |
