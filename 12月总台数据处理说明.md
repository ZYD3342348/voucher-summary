# 12月总台财务数据处理说明（精简版）

## 快速使用
- 生成汇总：`python3 2025年12月/generate_summary.py`  
  默认读取 `12月总台.XLS.xlsx`，输出 `12月汇总输出.xlsx`。
- 批量测试：`python3 2025年12月/run_tests.py`  
  扫描 `测试数据` 目录生成同名 `_汇总输出.xlsx`。
- 转账提取规则（总数表）：先找首个单元格恰好等于“转账”的行；从该列向右取首个金额(≥1000)，若无则取该行金额(≥1000)的最小值；若无恰好“转账”行，再退回含“转账”关键字的首行同样取值。
- 公式链核心：`B1` 转账金额 → `B13` 房费总计 → `B14=B13-$B$1` 房费剩余 → `C18/19/20` H/L/T → `C21` 调整S → `C22` 凭证合计 → `B27` 验证。
- 总数表长表化（可选）：`python3 2025年12月/voucher-summary-generator/scripts/normalize_total.py -i <文件> -s 总数 -o 输出.csv`，输出列 `code,name,debit,credit,source_file,source_row`，可直接筛 `name=="转账"` 提取金额。

## 数据源与结构
- 文件：`/Users/zengyuntan/python/凭证处理/2025年12月/12月总台.XLS.xlsx`
- 主要工作表：  
  - 总台（原始明细，账号/房号/姓名/借方/贷方/操作员/入账时间/备注）  
  - 总数（汇总与转账行）  
  - 收入类型表（清洗后明细+透视）  
  - 价税分离、单位名称、银行回单等附表
- 数据流：总台 → 工作表 → 收入类型表（加收入类型、透视）。

## 脚本逻辑摘要
### generate_summary.py
- 读取明细（透视表上方区域）；若收入类型缺失，按“名称”首字母自动提取（Z/L/H/R/S/T），并统计与原列不一致数量。
- 项目标准化：`半日租` 归并为 `房费`。
- 生成透视表（行：收入类型；列：项目；值：金额），补齐缺失类型为0。
- 输出单表汇总：配置区、透视表、凭证说明、调整S、验证，全部用公式链。

### run_tests.py
- 针对 `测试数据` 下示例文件批量生成 `_汇总输出.xlsx`。
- 自动选择 `收入类型表` 或 `收入类型` 工作表；缺失则跳过。
- 转账金额按上述规则自动提取。

## 公式链要点
- 房费总计：`B13 =SUM(B7:B12)`（H/L/R/S/T/Z 房费之和）
- 房费剩余：`B14 =B13-$B$1`
- 凭证金额：`C18 =B7`(H)，`C19 =B8`(L)，`C20 =B11`(T)，`C21 =B13-$B$1-B7-B8-B11`（调整S）
- 凭证合计：`C22 =SUM(C18:C21)`
- 验证：`B27 =IF(B14=C22,"✓ 正确","✗ 错误")`

## 价税分离（简述）
- 需价税分离的项目：房费、餐费、代收费、俱乐部活动费、赔偿费、五号楼咖啡厅、各场地费、中医馆理疗等。
- 会议/非会议区分：H 内部/不计税；S 房费非会议；俱乐部活动费按5%，赔偿费按6% 等。

## 备注
- 若遇到收入类型列缺失，脚本会自动提取并提示不一致行数，便于人工核对。
- 若“总数”表结构有变（转账行位置、列偏移），可调整转账提取规则或提供示例再优化。*** End Patch**");
