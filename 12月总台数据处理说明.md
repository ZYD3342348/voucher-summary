# 12月总台财务数据处理说明

## 数据源

- **文件路径**：`/Users/zengyuntan/python/凭证处理/2025年12月/12月总台.XLS.xlsx`
- **数据期间**：2025年12月1日 - 12月31日
- **数据来源**：深圳市干部人才健康管理中心 总台账务明细报表

## 工作表结构

### 原始数据工作表

| 工作表 | 行数 | 说明 |
|--------|------|------|
| 总台 | 7866行 | 原始账务明细，含账号、房号、姓名、借方、贷方、操作员、入账时间、备注 |
| 总数 | 47行 | 汇总统计 |
| 银行回单 | 65行 | 银行电子回单信息 |
| 示例 | 63行 | 住宿费示例（含图片公式） |
| 老干财政 | 139行 | 老干财政记账明细 |

### 清洗后工作表

| 工作表 | 行数 | 说明 |
|--------|------|------|
| 工作表 | 6501行 | 第一轮清洗后的交易记录 |
| 收入类型表 | 6529行 | 工作表基础上添加收入类型列 + 透视表汇总 |
| 单位名称 | 994行 | 按消费单位汇总 |
| 价税分离 | 76行 | 各项目价税分离明细 |

## 数据流转

```
总台(原始数据) → 工作表(清洗后) → 收入类型表(添加收入类型 + 透视表)
```

## 输出规范

### 通用要求：非脚本运算使用Excel公式

在输出Excel文件时，凡是通过计算得出的数据，**必须使用Excel公式**而非直接填入数值，以确保数据可追溯、可动态更新。

### 程序友好设计

为支持**纯本地运行**和**任意AI执行**，输出表格采用以下设计：

#### 设计原则

| 原则 | 说明 |
|------|------|
| **单表输出** | 所有内容整合到一个Excel，减少文件依赖 |
| **配置区分离** | 可配置参数（如转账金额）集中在表头 |
| **公式短链** | 引用链尽量短，避免跨表引用 |
| **增量更新** | 修改输入数据后，全表自动重算 |

#### 表格结构

```
【配置区】  - 行1-3   : 转账金额、数据文件（可配置）
【透视表】  - 行6-13  : 按收入类型×项目交叉汇总
【凭证说明】- 行16-21 : H/L/T/调整S凭证（引用透视表）
【调整S计算】- 行24-31: 完整的调整S计算链
【验证】    - 行33-38 : 验证公式（自动校验）
```

#### 公式引用链

```
透视表房费(B7,B8,B11)
    ↓
凭证说明(C17,C18,C19)
    ↓
调整S计算(B28,B29,B30) → 调整S(B31)
    ↓
凭证调整S引用(C20) → 凭证合计(C21)
    ↓
验证(B38): IF(房费剩余=凭证合计)
```

#### 纯Python执行脚本

```python
import pandas as pd
from openpyxl import Workbook

# 配置
INPUT_FILE = '12月总台.XLS.xlsx'
OUTPUT_FILE = '12月汇总输出.xlsx'
TRANSFER_AMOUNT = 600240  # 从总数表获取

# 读取并处理数据
df = pd.read_excel(INPUT_FILE, sheet_name='收入类型表', header=None)
df = df.iloc[:6502, :4]
df.columns = ['项目', '名称', '收入类型', '金额']

# 创建透视表
pivot = df.pivot_table(index='收入类型', columns='项目', values='金额', aggfunc='sum')

# 计算调整S
room_total = pivot['房费'].sum()
adjust_S = room_total - TRANSFER_AMOUNT - pivot.loc['H', '房费'] - pivot.loc['L', '房费'] - pivot.loc['T', '房费']

# 输出Excel（含公式）
# ... (生成包含完整公式链的Excel文件)
```

**好处**：
- 任何AI只需执行此脚本即可完成全部处理
- 本地无需人工干预
- 结果可验证、可追溯

**原则**：
- 透视表小计/总计使用 `SUM` 公式
- 引用其他单元格的值使用单元格地址（如 `=B7`）
- 跨表引用使用 `='工作表名'!单元格地址`
- 计算结果（如调整S）使用组合公式

**示例**：
```
# 透视表行总计
=SUM(B7:K7)

# 引用其他单元格
=B7

# 计算调整S
=房费剩余 - H房费 - L房费 - T房费
=房费总计 - 转账金额 - H房费 - L房费 - T房费
```

**好处**：
- 数据来源清晰可查
- 源数据变化时自动更新结果
- 便于验证计算逻辑

## 数据清洗步骤

从"工作表"到"收入类型表"的处理步骤：

1. **项目统一**：将"半日租"替换为"房费"（两者本质相同，统一归类）
2. **提取收入类型**：提取"名称"列的首字母（Z/L/H/R/S/T）作为收入类型

### 半日租转换逻辑

原始数据中，"半日租"与"房费"本质相同，需统一归类。

| 转换前 | 转换后 | 行数 | 金额 |
|--------|--------|------|------|
| 半日租 | 房费 | 311行 | 28,835.00 |

**Python实现**：
```python
# 将"半日租"替换为"房费"
df.loc[df['项目'] == '半日租', '项目'] = '房费'
```

### 收入类型识别逻辑

单位名称的**首字母**直接标识了该笔收入的类型，无需额外判断。

### 名称格式

```
首字母 + 单位名称 + _后缀
```

### 收入类型对应表

| 首字母 | 收入类型 | 说明 | 示例 |
|--------|----------|------|------|
| Z | Z | 政府机关 | Z福田区、Z国税局深圳市税务局 |
| L | L | 老干部/财政 | L深圳市应急管理局、L深圳大学 |
| H | H | 会议/内部成本 | H超算中心、H第九期游学营 |
| R | R | 人才 | R人才（宝能汽车有限公司）、R人才（华为） |
| S | S | 散客 | S体检家属、S散客 |
| T | T | 其他事业单位 | T深圳大学、T鹏城实验室 |

### 收入类型分布统计

| 收入类型 | 记录数 |
|----------|--------|
| T | 2037 |
| L | 1630 |
| Z | 1118 |
| H | 934 |
| R | 682 |
| S | 101 |
| 其他 | 6 |

## 收入类型表结构

### 数据区域（行1-6502）

列名：
- `项目`：消费项目（房费、餐费、代收费等）
- `名称`：单位名称
- `收入类型`：识别后的收入类型（Z/L/H/R/S/T）
- `金额`：消费金额

### 透视表汇总（Excel行6503-6513）

使用Excel数据透视表功能，基于明细数据创建交叉汇总。

#### 透视表配置

| 配置项 | 设置 |
|--------|------|
| **行** | 收入类型（H、L、R、S、T、Z、总计） |
| **列** | 项目（保健费老干、餐费、代收费、房费、活动费、俱乐部活动费、赔偿费、晚餐餐费、五号楼咖啡厅、智汇中心报告厅、智汇中心多功能厅、智汇中心湖畔沙龙、智汇中心咖啡厅、智汇中心培训室、智汇中心小会议室、中医馆理疗、总计） |
| **值** | 金额（求和） |

#### 透视表结果

| 收入类型 | 保健费老干 | 餐费 | 代收费 | 房费 | 活动费 | 俱乐部活动费 | 赔偿费 | 晚餐餐费 | 五号楼咖啡厅 | 智汇中心报告厅 | 智汇中心多功能厅 | 智汇中心湖畔沙龙 | 智汇中心咖啡厅 | 智汇中心培训室 | 智汇中心小会议室 | 中医馆理疗 | 总计 |
|----------|------------|------|--------|------|--------|--------------|--------|----------|--------------|----------------|------------------|------------------|----------------|----------------|------------------|------------|------|
| H | - | 600360 | 252487.74 | 1328805 | - | -900 | 660 | - | 278 | 311030 | 12000 | 20000 | 29354.69 | 20000 | 44000 | 43500 | 2661575.43 |
| L | 26380 | - | - | 92240 | 26380 | - | 70 | 105520 | - | - | - | - | - | - | - | - | 250590 |
| R | - | - | - | 266800 | - | - | 80 | - | - | - | - | - | - | - | - | - | 266880 |
| S | - | 1600 | - | 17100 | - | - | 20 | - | 54 | - | - | - | - | - | - | - | 18774 |
| T | - | - | - | 218160 | - | - | 70 | - | - | - | - | - | - | - | - | - | 218230 |
| Z | - | - | - | 422760 | - | - | 188 | - | - | - | - | - | - | - | - | - | 422948 |
| **总计** | 26380 | 601960 | 252487.74 | 2345865 | 26380 | -900 | 1088 | 105520 | 332 | 311030 | 12000 | 20000 | 29354.69 | 20000 | 44000 | 43500 | 3838997.43 |

#### 凭证摘要说明（Excel行6515-6518）

根据收入类型，需要制作凭证说明的收入类型：

| 收入类型 | 凭证摘要 | 金额 | 说明 |
|----------|----------|------|------|
| H | 总台收入-住宿费（会议类） | 1,328,805 | 会议类，单独凭证 |
| L | 总台收入-住宿费 | 92,240 | 老干部/财政 |
| T | 总台收入-住宿费 | 218,160 | 其他事业单位 |
| **调整S** | 总台收入-住宿费 | 106,420 | 计算出的差额 |

**调整S**：扣除转账和H、L、T类型后的剩余金额。

#### 房费金额逻辑关系

```
房费总计:     2,345,865
减转账:         600,240   ← 来源：总数表的"转账"记录
─────────────────────
房费剩余:       1,745,625

房费剩余 = H + L + T + 调整S
1,745,625 = 1,328,805 + 92,240 + 218,160 + 106,420 ✓
```

### 调整S计算公式

**调整S** = 房费总计 - 转账金额 - H房费 - L房费 - T房费

| 项目 | 数据来源 | 说明 |
|------|----------|------|
| 房费总计 | 透视表"总计"行的"房费"列 | 所有房费合计 |
| 转账金额 | 总数表"转账"记录 | 独立维护的转账金额 |
| H房费 | 透视表"H"行的"房费"列 | 会议/内部成本类房费 |
| L房费 | 透视表"L"行的"房费"列 | 老干部/财政类房费 |
| T房费 | 透视表"T"行的"房费"列 | 其他事业单位类房费 |
| **调整S** | 计算结果 | 扣除转账和H/L/T后的剩余金额 |

**计算逻辑**：
```
房费剩余 = 房费总计 - 转账金额
调整S   = 房费剩余 - H房费 - L房费 - T房费
```

**Python实现**：
```python
# 转账金额从总数表获取（独立维护）
transfer_amount = 总数表['转账']

# 房费从透视表获取
room_total = pivot.loc['总计', '房费']
voucher_H = pivot.loc['H', '房费']
voucher_L = pivot.loc['L', '房费']
voucher_T = pivot.loc['T', '房费']

# 计算调整S
room_remaining = room_total - transfer_amount
adjust_S = room_remaining - voucher_H - voucher_L - voucher_T
```

#### Python实现

```python
import pandas as pd

# 读取已添加收入类型列的数据
df = pd.read_excel('12月总台.XLS.xlsx', sheet_name='收入类型表')

# 只取明细数据区域（排除透视表）
df = df.iloc[:6502]

# 创建透视表
pivot = df.pivot_table(
    index='收入类型',       # 行
    columns='项目',         # 列
    values='金额',          # 值
    aggfunc='sum',         # 求和
    margins=True,          # 包含总计
    fill_value=0           # 空值填0
)

### 2025年12月脚本（generate_summary.py）运行与公式链检查

- 位置：`2025年12月/generate_summary.py`
- 运行：`python3 generate_summary.py`（默认读取同目录的 `12月总台.XLS.xlsx` → 输出 `12月汇总输出.xlsx`）
- 动态公式：所有凭证/验证公式均由脚本拼接，关键引用不再硬编码位置。
  - 配置区：`B1` 为转账金额，后续公式使用 `$B$1` 引用（更换转账金额无需改公式）。
  - 房费总计：`B13 =SUM(B7:B12)`（H/L/R/S/T/Z 房费之和）。
  - 房费剩余：`B14 =B13-$B$1`。
  - 凭证金额：`C18 =B7`(H)，`C19 =B8`(L)，`C20 =B11`(T)，`C21 =B13-$B$1-B7-B8-B11`（调整S）。
  - 凭证合计：`C22 =SUM(C18:C21)`，验证：`B27 =IF(B14=C22,"✓ 正确","✗ 错误")`。
- 适应性：即便收入类型缺行，也会补0并保持行序，避免因插入/删除行导致引用错位。
```

## 价税分离规则

### 非会议且需要价税分离

- **S房费**：散客房费
- **俱乐部活动费**：如有网球按5%计算
- **赔偿费**：按6%计算

### 计税规则

| 类型 | 会议/非会议 | 不含税收入 | 税额 |
|------|-------------|------------|------|
| H内部成本+不计税 | - | - | - |
| H不含税收入-赔偿费 | 会议 | 481.13 | 28.87 |
| S非会议 | 非会议 | 428.00 | 24.23 |

### 价税分离项目清单

- 餐费
- 代收费
- 房费
- 俱乐部活动费
- 赔偿费
- 五号楼咖啡厅
- 智汇中心报告厅
- 智汇中心多功能厅
- 智汇中心湖畔沙龙
- 智汇中心咖啡厅
- 智汇中心培训室
- 智汇中心小会议室
- 中医馆理疗

## 分类结构（住宿）

根据`Sheet1`工作表：

1. **一.内部成本** - H类型
2. **二.不计税** - 部分L类型
3. **三.计税** - Z、R、S、T类型

## 项目类型

- 房费
- 餐费
- 代收费
- 活动费
- 俱乐部活动费
- 赔偿费
- 晚餐餐费
- 各场地费用（智汇中心报告厅、培训室、小会议室等）
- 中医馆理疗
