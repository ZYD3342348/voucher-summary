# 12月总台财务数据处理说明（当前流程）

## 目标与范围
- 从“工作表”直接生成汇总/凭证/验证表，无需预置“收入类型表”。
- 从“总数”表长表化后计算转账、资金汇总、倒推校验。
- 支持价税分离透视（按收入类型过滤，如 H）与可编辑的税率/计税调整表（计划中）。
- 所有规则（转账、资金汇总映射、税率/计税、项目归并）可外置配置，便于业务调整。

## 验收标准
- 明细读取：自动定位“项目/名称/金额”列，名称去空格并去除下划线后缀；半日租归并房费；收入类型自动提取（首个英文字母）。
- 汇总表：房费总计、房费剩余、H/L/T、调整S、凭证合计、验证公式链正确引用；转账金额符合规则。
- 转账提取（长表）：`name=="转账"` 贷方优先，否则借方；无精确再退模糊；结果与人工期望一致。
- 总数表倒推：银行/微信/现金/拉卡拉/财政汇总与凭证贷方/借方、应挂账金额计算正确；生成异常/未匹配提示。
- 价税分离透视（H）：名称×项目透视，动态列，含合计行列；若提供转账可计算房费调整S（示例已跑 8 月）。
- 文档与脚本一致：使用方式、规则、输出说明与实际行为匹配。

## 快速使用
- 汇总生成：`python3 2025年12月/generate_summary.py`  
  从“工作表”直接读取明细，自动定位列、提取收入类型，输出 `12月汇总输出.xlsx`。
- 批量测试：`python3 2025年12月/run_tests.py`  
  批量生成 `_汇总输出.xlsx`（含转账自动提取）。
- 总数表长表+倒推：`python3 2025年12月/voucher-summary-generator/scripts/normalize_total.py -i <文件> -s 总数 -o 输出.csv`
- 工作表长表：`python3 2025年12月/voucher-summary-generator/scripts/normalize_work.py -i <文件> -s 工作表 -o 输出.csv -t <转账>`（可选，计算房费总计/调整S）

## 数据处理逻辑
### 工作表明细（generate_summary.py / normalize_work.py）
- 列定位：优先用内容定位含“项目”“名称”的表头行和列；找不到则退回列0=项目、列2=名称。金额列自动检测“数值最多的列”。
- 清洗：名称去空格，`半日租` 归并到 `房费`。
- 收入类型：名称中首个英文字母（大写，Z/L/H/R/S/T），自动生成并用于透视；若原列缺失也能生成。
- 透视与调整S：房费按收入类型汇总；调整S = 房费总计 - 转账 - H房费 - L房费 - T房费；公式链输出到 Excel（配置区→透视→凭证→验证）。

### 总数表（normalize_total.py）
- 长表化：输出 `code,name,debit,credit,source_file,source_row`。
- 汇总：银行（含银行转账/转帐/银行/AR支票预收）、微信（含微信/微信支付/微信汇总）、现金（含现金结账/AR现金预收）、拉卡拉（含拉卡拉/预收/银联POS）、财政（含财政/财政汇总）。
- 倒推校验：  
  - 凭证贷方 = 借方合计 - 转账 - 转内部成本  
  - 应挂账金额 = 凭证贷方 - 银行汇总 - 微信汇总 - 现金汇总 - 拉卡拉汇总 - 财政汇总  
  - 凭证借方 = 银行汇总 + 微信汇总 + 现金汇总 + 拉卡拉汇总 + 财政汇总 + 应挂账金额

### 转账提取规则
- 建议使用长表规则：`name == "转账"` 行，优先取贷方 `credit`，为空则取借方；无精确“转账”再退回包含“转账”的首行。同名多行可根据需要取首条或求和（当前取首条）。
- 原宽表“向右取首个金额”仅作为历史兼容。

## 示例（2025年8月，基于工作表生成）
- 收入类型分布：H 721, L 1131, R 369, S 98, T 2011, Z 595
- 房费透视：H 293,661；L 64,680；R 130,880；S 16,740；T 188,080；Z 227,820；房费总计 921,861
- 转账（总数表长表提取）：351,260
- 调整S：24,180（房费总计 - 转账 - H - L - T）
- 总数表倒推示例（8月）：银行 83,650；微信 9,323；现金 1,200；拉卡拉 61,749；财政 70,000；凭证贷方 1,921,518；应挂账 1,695,596；凭证借方 1,921,518

## 公式链（生成的汇总 Excel）
- 房费总计：`B13 =SUM(B7:B12)`（H/L/R/S/T/Z 房费）
- 房费剩余：`B14 =B13-$B$1`（转账在配置区 B1）
- 凭证金额：`C18 =B7`(H)，`C19 =B8`(L)，`C20 =B11`(T)，`C21 =B13-$B$1-B7-B8-B11`（调整S）
- 凭证合计：`C22 =SUM(C18:C21)`
- 验证：`B27 =IF(B14=C22,"✓ 正确","✗ 错误")`

## 备注
- 如果文件结构或名称有所变动，可先用 normalize_work/normalize_total 检查长表输出，再调整聚合名称映射。***
